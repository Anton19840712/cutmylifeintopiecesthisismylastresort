<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Auto SIP Test</title>
    <script src="https://cdn.jsdelivr.net/npm/jssip@3.10.1/dist/jssip.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #00ff00; }
        #log { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>SIP Auto Registration Test</h2>
    <div id="log"></div>

    <script>
        const logDiv = document.getElementById('log');

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${msg}\n`;
            console.log(msg);
        }

        log('Страница загружена');
        log('JsSIP версия: ' + (typeof JsSIP !== 'undefined' ? 'загружена' : 'НЕ ЗАГРУЖЕНА'));

        if (typeof JsSIP === 'undefined') {
            log('ОШИБКА: JsSIP не загружен!');
        } else {
            log('Начинаю автоматическую регистрацию...');
            log('');

            try {
                const socket = new JsSIP.WebSocketInterface('ws://localhost:8088');
                log('✓ WebSocket интерфейс создан');

                const config = {
                    sockets: [socket],
                    uri: 'sip:anton-test@sip.linphone.org',
                    password: 'Ant6729@$%#',
                    display_name: 'anton-test',
                    register: true,
                    session_timers: false
                };
                log('✓ Конфигурация создана');
                log('  URI: ' + config.uri);

                const ua = new JsSIP.UA(config);
                log('✓ User Agent создан');

                ua.on('connecting', () => log('→ WebSocket подключается...'));
                ua.on('connected', () => log('✓ WebSocket ПОДКЛЮЧЕН'));
                ua.on('disconnected', () => log('✗ WebSocket ОТКЛЮЧЕН'));
                ua.on('registered', () => log('✓✓✓ УСПЕШНАЯ РЕГИСТРАЦИЯ на SIP сервере!'));
                ua.on('unregistered', () => log('Отменена регистрация'));
                ua.on('registrationFailed', (e) => {
                    log('✗✗✗ ОШИБКА РЕГИСТРАЦИИ:');
                    log('  Причина: ' + e.cause);
                    log('  Ответ: ' + (e.response ? e.response.status_code : 'нет'));
                });

                ua.start();
                log('✓ User Agent запущен');

            } catch (e) {
                log('✗✗✗ ИСКЛЮЧЕНИЕ: ' + e.message);
                log('Stack: ' + e.stack);
            }
        }
    </script>
</body>
</html>
