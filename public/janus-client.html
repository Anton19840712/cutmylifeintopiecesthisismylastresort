<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Janus SIP Client - Anton to Roman</title>
    <script src="janus.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #0f0; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #0a0;
            color: #000;
            border: none;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover { background: #0f0; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        #log {
            background: #000;
            border: 1px solid #0f0;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            margin-top: 10px;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Janus WebRTC Gateway - SIP Client</h1>
        <p>Anton (anton-test) ‚Üí sip.linphone.org ‚Üí Roman (romaous)</p>

        <div>
            <button id="initBtn" onclick="initJanus()">1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Janus</button>
            <button id="registerBtn" onclick="registerSIP()" disabled>2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ SIP</button>
            <button id="callBtn" onclick="makeCall()" disabled>3. –ü–æ–∑–≤–æ–Ω–∏—Ç—å –†–æ–º–∞–Ω—É</button>
            <button id="hangupBtn" onclick="hangup()" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>

        <audio id="remoteAudio" autoplay></audio>
        <div id="log"></div>
    </div>

    <script>
        let janus = null;
        let sipcall = null;
        let opaqueId = "siptest-" + Janus.randomString(12);

        const SIP_SERVER = "sip:sip.linphone.org";
        const USERNAME = "anton-test";
        const PASSWORD = "Ant6729@$%#";
        const DESTINATION = "sip:romaous@sip.linphone.org";

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 8);
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function initJanus() {
            log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Janus...', 'info');
            document.getElementById('initBtn').disabled = true;

            Janus.init({
                debug: "all",
                callback: function() {
                    if(!Janus.isWebrtcSupported()) {
                        log('WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è!', 'error');
                        return;
                    }

                    log('‚úì Janus –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                    log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Janus Gateway ws://localhost:8188...', 'info');

                    janus = new Janus({
                        server: 'ws://localhost:8188',
                        success: function() {
                            log('‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Janus Gateway!', 'success');
                            attachToSIPPlugin();
                        },
                        error: function(error) {
                            log('‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Janus: ' + error, 'error');
                        },
                        destroyed: function() {
                            log('–°–µ—Å—Å–∏—è Janus –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'info');
                        }
                    });
                }
            });
        }

        function attachToSIPPlugin() {
            log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SIP –ø–ª–∞–≥–∏–Ω—É...', 'info');

            janus.attach({
                plugin: "janus.plugin.sip",
                opaqueId: opaqueId,
                success: function(pluginHandle) {
                    sipcall = pluginHandle;
                    log('‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ SIP –ø–ª–∞–≥–∏–Ω—É!', 'success');
                    log('Handle ID: ' + sipcall.getId(), 'info');
                    document.getElementById('registerBtn').disabled = false;
                },
                error: function(error) {
                    log('‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ SIP –ø–ª–∞–≥–∏–Ω—É: ' + error, 'error');
                },
                consentDialog: function(on) {
                    log('Consent dialog: ' + on, 'info');
                },
                iceState: function(state) {
                    log('ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ' + state, 'info');
                },
                mediaState: function(medium, on, mid) {
                    log('Media ' + medium + ': ' + (on ? 'ON' : 'OFF'), 'info');
                },
                webrtcState: function(on) {
                    log('WebRTC —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ' + (on ? 'UP' : 'DOWN'), on ? 'success' : 'error');
                },
                onmessage: function(msg, jsep) {
                    log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç SIP –ø–ª–∞–≥–∏–Ω–∞', 'info');
                    log('Message: ' + JSON.stringify(msg), 'info');

                    const event = msg["result"]["event"];

                    if(event === 'registration_failed') {
                        log('‚úó SIP —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: ' + msg["result"]["reason"], 'error');
                    } else if(event === 'registered') {
                        log('‚úì‚úì‚úì SIP –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê!', 'success');
                        log('Username: ' + msg["result"]["username"], 'success');
                        document.getElementById('callBtn').disabled = false;
                    } else if(event === 'calling') {
                        log('üìû –ó–≤–æ–Ω–∏–º...', 'info');
                    } else if(event === 'accepted') {
                        log('‚úì –ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç!', 'success');
                        if(jsep) {
                            sipcall.handleRemoteJsep({ jsep: jsep });
                        }
                    } else if(event === 'hangup') {
                        log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–∏—á–∏–Ω–∞: ' + msg["result"]["reason"], 'info');
                        document.getElementById('callBtn').disabled = false;
                        document.getElementById('hangupBtn').disabled = true;
                    } else if(event === 'progress') {
                        log('üìû –í—ã–∑–æ–≤ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...', 'info');
                        if(jsep) {
                            sipcall.handleRemoteJsep({ jsep: jsep });
                        }
                    }

                    if(jsep) {
                        log('–û–±—Ä–∞–±–æ—Ç–∫–∞ JSEP: ' + JSON.stringify(jsep), 'info');
                        sipcall.handleRemoteJsep({ jsep: jsep });
                    }
                },
                onlocaltrack: function(track, on) {
                    log('Local track ' + (on ? 'added' : 'removed'), 'info');
                },
                onremotetrack: function(track, mid, on) {
                    log('Remote track ' + (on ? 'added' : 'removed'), on ? 'success' : 'info');
                    if(on) {
                        const stream = new MediaStream([track]);
                        Janus.attachMediaStream(document.getElementById('remoteAudio'), stream);
                        log('‚úì –ê—É–¥–∏–æ –ø–æ—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —ç–ª–µ–º–µ–Ω—Ç—É!', 'success');
                    }
                },
                oncleanup: function() {
                    log('WebRTC cleanup', 'info');
                }
            });
        }

        function registerSIP() {
            log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ SIP —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é...', 'info');
            log(`Server: ${SIP_SERVER}, User: ${USERNAME}`, 'info');
            document.getElementById('registerBtn').disabled = true;

            const register = {
                request: "register",
                type: "guest",
                username: USERNAME,
                secret: PASSWORD,
                authuser: USERNAME,
                display_name: "Anton Test",
                proxy: SIP_SERVER
            };

            log('–û—Ç–ø—Ä–∞–≤–∫–∞: ' + JSON.stringify(register), 'info');
            sipcall.send({ message: register });
        }

        async function makeCall() {
            log('–ù–∞—á–∏–Ω–∞–µ–º –∑–≤–æ–Ω–æ–∫ –Ω–∞ ' + DESTINATION, 'info');
            document.getElementById('callBtn').disabled = true;
            document.getElementById('hangupBtn').disabled = false;

            try {
                // Request microphone access
                log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'info');

                sipcall.createOffer({
                    tracks: [
                        { type: 'audio', capture: true, recv: true }
                    ],
                    success: function(jsep) {
                        log('‚úì Offer —Å–æ–∑–¥–∞–Ω', 'success');
                        log('JSEP: ' + JSON.stringify(jsep), 'info');

                        const call = {
                            request: "call",
                            uri: DESTINATION
                        };

                        log('–û—Ç–ø—Ä–∞–≤–∫–∞ INVITE –Ω–∞ ' + DESTINATION, 'info');
                        sipcall.send({ message: call, jsep: jsep });
                    },
                    error: function(error) {
                        log('‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ' + error, 'error');
                        document.getElementById('callBtn').disabled = false;
                        document.getElementById('hangupBtn').disabled = true;
                    }
                });
            } catch(err) {
                log('‚úó –û—à–∏–±–∫–∞: ' + err, 'error');
                document.getElementById('callBtn').disabled = false;
                document.getElementById('hangupBtn').disabled = true;
            }
        }

        function hangup() {
            log('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞...', 'info');
            const hangup = { request: "hangup" };
            sipcall.send({ message: hangup });
            document.getElementById('callBtn').disabled = false;
            document.getElementById('hangupBtn').disabled = true;
        }

        log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Janus"', 'success');
    </script>
</body>
</html>
